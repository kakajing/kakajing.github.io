<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="前端," />





  <link rel="alternate" href="/atom.xml" title="余鸢" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="小程序从后端接收来自客户端发过来的code，通过code获取openid和sessionKey，根据openid和sessionKey生成用户专属的token存入到用户数据库里，也可以存入Redis或者MongooDb里，同时把token返回给小程序。当用户再次打开小程序时会把之前的token或者sessionKey来识别用户，把用户从Redis或者MongooDb里检索出来，来锁定并维持用户的的">
<meta property="og:type" content="article">
<meta property="og:title" content="微信公众号开发(十)：微信小程序支付和订单以及打包编译">
<meta property="og:url" content="http://kakajing.github.io/2018/09/17/微信公众号开发(十)：微信小程序支付和订单以及打包编译/index.html">
<meta property="og:site_name" content="余鸢">
<meta property="og:description" content="小程序从后端接收来自客户端发过来的code，通过code获取openid和sessionKey，根据openid和sessionKey生成用户专属的token存入到用户数据库里，也可以存入Redis或者MongooDb里，同时把token返回给小程序。当用户再次打开小程序时会把之前的token或者sessionKey来识别用户，把用户从Redis或者MongooDb里检索出来，来锁定并维持用户的的">
<meta property="og:updated_time" content="2018-10-06T15:51:24.575Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="微信公众号开发(十)：微信小程序支付和订单以及打包编译">
<meta name="twitter:description" content="小程序从后端接收来自客户端发过来的code，通过code获取openid和sessionKey，根据openid和sessionKey生成用户专属的token存入到用户数据库里，也可以存入Redis或者MongooDb里，同时把token返回给小程序。当用户再次打开小程序时会把之前的token或者sessionKey来识别用户，把用户从Redis或者MongooDb里检索出来，来锁定并维持用户的的">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://kakajing.github.io/2018/09/17/微信公众号开发(十)：微信小程序支付和订单以及打包编译/"/>





  <title> 微信公众号开发(十)：微信小程序支付和订单以及打包编译 | 余鸢 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?66daf35770118999428423836e567c4c";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>








  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <a href="https://github.com/kakajing"><img style="position: absolute; top: 0; left: 0; border: 0;" src="https://camo.githubusercontent.com/8b6b8ccc6da3aa5722903da7b58eb5ab1081adee/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f6c6566745f6f72616e67655f6666373630302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_left_orange_ff7600.png"></a>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">余鸢</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
    
      <p class="site-subtitle">每天学习一点点</p>
    
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://kakajing.github.io/2018/09/17/微信公众号开发(十)：微信小程序支付和订单以及打包编译/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="余鸢">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="余鸢">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="余鸢" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                微信公众号开发(十)：微信小程序支付和订单以及打包编译
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-09-17T15:24:33+08:00">
                2018-09-17
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/小程序/" itemprop="url" rel="index">
                    <span itemprop="name">小程序</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="小程序"><a href="#小程序" class="headerlink" title="小程序"></a>小程序</h1><p>从后端接收来自客户端发过来的code，通过code获取openid和sessionKey，根据openid和sessionKey生成用户专属的token存入到用户数据库里，也可以存入Redis或者MongooDb里，同时把token返回给小程序。当用户再次打开小程序时会把之前的token或者sessionKey来识别用户，把用户从Redis或者MongooDb里检索出来，来锁定并维持用户的的登录状态<br><a id="more"></a></p>
<h2 id="登录"><a href="#登录" class="headerlink" title="登录"></a>登录</h2><p>新建mina.js用来专门存放小程序的路由。小程序可以通过微信官方提供的登录能力方便地获取微信提供的用户身份标识，快速建立小程序内的用户体系。</p>
<p><strong>server/routes/mina.js</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> &#123; controller, get, post, required &#125; <span class="keyword">from</span> <span class="string">'../decorator/router'</span></div><div class="line"><span class="keyword">import</span> config <span class="keyword">from</span> <span class="string">'../config'</span></div><div class="line"></div><div class="line">@controller(<span class="string">'/mina'</span>)</div><div class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">MinaController</span> </span>&#123;</div><div class="line">  @get(<span class="string">'/login'</span>)</div><div class="line">  @required(&#123; <span class="attr">body</span>: [<span class="string">'code'</span>, <span class="string">'avatarUrl'</span>, <span class="string">'nickName'</span>] &#125;)</div><div class="line">  <span class="keyword">async</span> login (ctx, next) &#123;</div><div class="line">    <span class="keyword">const</span> &#123; code, avatarUrl, nickName &#125; = ctx.request.body</div><div class="line"></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      <span class="keyword">const</span> &#123; openid, unionid &#125; = <span class="keyword">await</span> openidAndSessionKey(code)</div><div class="line"></div><div class="line">      <span class="keyword">let</span> user = <span class="keyword">await</span> user.findOne(&#123;</div><div class="line">        openid</div><div class="line">      &#125;).exec()</div><div class="line"></div><div class="line">      <span class="keyword">if</span> (!user) &#123;</div><div class="line">        user = <span class="keyword">new</span> user(&#123;</div><div class="line">          <span class="attr">openid</span>: [openid],</div><div class="line">          <span class="attr">nickName</span>: nickName,</div><div class="line">          unionid,</div><div class="line">          avatarUrl</div><div class="line">        &#125;)</div><div class="line">        user = <span class="keyword">await</span> user.save()</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">        user.avatarUrl = avatarUrl</div><div class="line">        user.nickName = nickName</div><div class="line">        user = <span class="keyword">await</span> user.save()</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      ctx.body = &#123;</div><div class="line">        <span class="attr">success</span>: <span class="literal">true</span>,</div><div class="line">        <span class="attr">data</span>: &#123;</div><div class="line">          <span class="attr">nickName</span>: nickName,</div><div class="line">          <span class="attr">avatarUrl</span>: avatarUrl</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</div><div class="line">      ctx.body = &#123;</div><div class="line">        <span class="attr">success</span>: <span class="literal">false</span>,</div><div class="line">        <span class="attr">err</span>: e</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>注意</strong>：只开发微信网页的话用openid就可以，如果是开发小程序或多个产品时需要通过开放平台绑定公众号、小程序拿到unionid，unionid是跨平台的，一个用户在各个产品下都是一个unionid，如果是通过openid来辨识的话，openid是会变化的</p>
<h2 id="使用code获取-session-key-和-openid"><a href="#使用code获取-session-key-和-openid" class="headerlink" title="使用code获取 session_key 和 openid"></a>使用code获取 session_key 和 openid</h2><p>构建小程序函数。接收参数code，声明配置参数opts，发送请求传入opts返回数据</p>
<p><strong>server/wechat-lib/mina.js</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> config <span class="keyword">from</span> <span class="string">'../config'</span></div><div class="line"><span class="keyword">import</span> rp <span class="keyword">from</span> <span class="string">'request-promise'</span></div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="keyword">const</span> openidAndSessionKey = <span class="keyword">async</span> code =&gt; &#123;</div><div class="line">  <span class="keyword">let</span> opts = &#123;</div><div class="line">    <span class="attr">uri</span>: <span class="string">'https://api.weixin.qq.com/sns/jscode2session'</span>,</div><div class="line">    <span class="attr">qs</span>: &#123;</div><div class="line">      <span class="attr">appid</span>: config.mina.appid,</div><div class="line">      <span class="attr">secret</span>: config.mina.secret,</div><div class="line">      <span class="attr">grant_type</span>: <span class="string">'authorization_code'</span></div><div class="line">    &#125;,</div><div class="line">    <span class="attr">json</span>: <span class="literal">true</span></div><div class="line">  &#125;</div><div class="line"></div><div class="line">  opts.qs.js_code = code</div><div class="line">  <span class="keyword">let</span> res = <span class="keyword">await</span> rp(opts)</div><div class="line"></div><div class="line">  <span class="keyword">return</span> res</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="获取sessionKey"><a href="#获取sessionKey" class="headerlink" title="获取sessionKey"></a>获取sessionKey</h2><p><strong>server/routers/mina.js</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">@get(<span class="string">'codeAndSessionKey'</span>)</div><div class="line">@required(&#123; <span class="attr">query</span>: [<span class="string">'code'</span>]&#125;)</div><div class="line"><span class="keyword">async</span> getCodeAndSessionKey (ctx, next) &#123;</div><div class="line">  <span class="keyword">const</span> &#123; code &#125; = ctx.query</div><div class="line">  <span class="keyword">let</span> res = <span class="keyword">await</span> openidAndSessionKey(code)</div><div class="line"></div><div class="line">  ctx.body = &#123;</div><div class="line">    <span class="attr">success</span>: <span class="literal">true</span>,</div><div class="line">    <span class="attr">data</span>: res</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="获取用户资料"><a href="#获取用户资料" class="headerlink" title="获取用户资料"></a>获取用户资料</h2><p>通过<code>openidAndSessionKey(code)</code>拿到用户资料，在数据里查到user，对拿到的数据进行加密解密</p>
<p><strong>server/routers/mina.js</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line">@get(<span class="string">'user'</span>)</div><div class="line">@required(&#123; <span class="attr">query</span>: [<span class="string">'code'</span>, <span class="string">'userInfo'</span>] &#125;)</div><div class="line"><span class="keyword">async</span> getUser (ctx, next) &#123;</div><div class="line">  <span class="keyword">const</span> &#123; code, userInfo &#125; = ctx.query</div><div class="line">  <span class="keyword">const</span> minaUser = <span class="keyword">await</span> openidAndSessionKey(code)</div><div class="line">  <span class="keyword">let</span> user = <span class="keyword">await</span> User.findOne(&#123;openid&#125;).exec()</div><div class="line">  <span class="keyword">if</span> (!user) &#123;</div><div class="line">    <span class="keyword">let</span> pc = <span class="keyword">new</span> WXBizDataCrypt(minaUser.sessionKey)</div><div class="line">    <span class="keyword">let</span> data = pc.decryptData(userInfo.encryptedData, userInfo.iv)</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      user = <span class="keyword">await</span> User.findOne(&#123;<span class="attr">openid</span>: data.openId&#125;)</div><div class="line"></div><div class="line">      <span class="keyword">if</span> (!user) &#123;</div><div class="line">        <span class="keyword">let</span> _userData = userInfo.userInfo</div><div class="line"></div><div class="line">        user = <span class="keyword">new</span> User(&#123;</div><div class="line">          <span class="attr">avatarUrl</span>: _userData.avatarUrl,</div><div class="line">          <span class="attr">nickName</span>: _userData.nickName,</div><div class="line">          <span class="attr">unionid</span>: data.unionid,</div><div class="line">          <span class="attr">openid</span>: [minaUser.openid],</div><div class="line">          <span class="attr">sex</span>: _userData.gender,</div><div class="line">          <span class="attr">country</span>: _userData.country,</div><div class="line">          <span class="attr">province</span>: _userData.province,</div><div class="line">          <span class="attr">city</span>: _userData.city</div><div class="line">        &#125;)</div><div class="line"></div><div class="line">        <span class="keyword">await</span> user.save()</div><div class="line">      &#125;</div><div class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</div><div class="line">      <span class="keyword">return</span> (ctx.body = &#123;</div><div class="line">        <span class="attr">success</span>: <span class="literal">false</span>,</div><div class="line">        <span class="attr">err</span>: e</div><div class="line">      &#125;)</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  ctx.body = &#123;</div><div class="line">    <span class="attr">success</span>: <span class="literal">true</span>,</div><div class="line">    <span class="attr">data</span>: &#123;</div><div class="line">      <span class="attr">nickName</span>: user.nickName,</div><div class="line">      <span class="attr">avatarUrl</span>: user.avatarUrl,</div><div class="line">      <span class="attr">sex</span>: user.sex</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="解密算法"><a href="#解密算法" class="headerlink" title="解密算法"></a>解密算法</h2><p>小程序通过<code>getUserInfo</code>拿到用户资料和敏感数据，需要对敏感数据解密</p>
<p><strong>server/wechat-lib/mina.js</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">WXBizDataCrypt</span> </span>&#123;</div><div class="line">  <span class="keyword">constructor</span> (sessionKey) &#123;</div><div class="line">    <span class="keyword">this</span>.appId = config.mina.appid</div><div class="line">    <span class="keyword">this</span>.sessionKey = sessionKey</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  decryptData (encryptedData, iv) &#123;</div><div class="line">    <span class="comment">// base64 decode</span></div><div class="line">    <span class="keyword">let</span> decoded</div><div class="line">    <span class="keyword">let</span> sessionKey = <span class="keyword">new</span> Buffer(<span class="keyword">this</span>.sessionKey, <span class="string">'base64'</span>)</div><div class="line">    encryptedData = <span class="keyword">new</span> Buffer(encryptedData, <span class="string">'base64'</span>)</div><div class="line">    iv = <span class="keyword">new</span> Buffer(iv, <span class="string">'base64'</span>)</div><div class="line"></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">       <span class="comment">// 解密</span></div><div class="line">      <span class="keyword">let</span> decipher = crypto.createDecipheriv(<span class="string">'aes-128-cbc'</span>, sessionKey, iv)</div><div class="line">      <span class="comment">// 设置自动 padding 为 true，删除填充补位</span></div><div class="line">      decipher.setAutoPadding(<span class="literal">true</span>)</div><div class="line">      decoded = decipher.update(encryptedData, <span class="string">'binary'</span>, <span class="string">'utf8'</span>)</div><div class="line">      decoded += decipher.final(<span class="string">'utf8'</span>)</div><div class="line">      decoded = <span class="built_in">JSON</span>.parse(decoded)</div><div class="line">    &#125; <span class="keyword">catch</span> (err) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Illegal Buffer'</span>)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (decoded.watermark.appid !== <span class="keyword">this</span>.appId) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Illegal Buffer'</span>)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> decoded</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>输入根路径进入index.vue页面跳转到二跳页面auth.vue拿到code，用code换token，再通过token拿到unionId和openid获取用户资料</p>
<h1 id="公众号商城支付"><a href="#公众号商城支付" class="headerlink" title="公众号商城支付"></a>公众号商城支付</h1><h2 id="增加中间件控制"><a href="#增加中间件控制" class="headerlink" title="增加中间件控制"></a>增加中间件控制</h2><p><strong>pages/deal/index.vue</strong>和<strong>page/shopping/index.vue</strong> 都各自加上中间件</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">middleware: <span class="string">'wechat-auth'</span>,</div></pre></td></tr></table></figure>
<h2 id="添加购买-取消动画框"><a href="#添加购买-取消动画框" class="headerlink" title="添加购买/取消动画框"></a>添加购买/取消动画框</h2><p>点击购买后跳出弹出框</p>
<p><strong>pages/deal/index.vue</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">transition(name=<span class="string">'slide-top'</span>)</div><div class="line">    payment-modal(v-<span class="keyword">if</span>=<span class="string">'showInfo'</span>)</div><div class="line">      .payment-modal-header</div><div class="line">        span 准备购买</div><div class="line">        span(@click=<span class="string">'showInfo = false'</span>) 取消</div><div class="line">      .payment-modal-body</div><div class="line">        .info-item</div><div class="line">          img(:src=<span class="string">'imageCDN2 + product.images[0]'</span>)</div><div class="line">          div</div><div class="line">            p &#123;&#123; product.title &#125;&#125;</div><div class="line">            p 价格 ￥&#123;&#123; product.price &#125;&#125;</div><div class="line">        .info-item</div><div class="line">          span 收件人</div><div class="line">          input(v-model.trim=<span class="string">'info.name'</span> placeholder=<span class="string">'你的名字'</span>)</div><div class="line">        .info-item</div><div class="line">          span 电话</div><div class="line">          input(v-model.trim=<span class="string">'info.phoneNumber'</span> type=<span class="string">'tel'</span> placeholder=<span class="string">'你的电话'</span>)</div><div class="line">        .info-item</div><div class="line">          span 地址</div><div class="line">          input(v-model.trim=<span class="string">'info.address'</span> type=<span class="string">'tel'</span> placeholder=<span class="string">'收货地址是？'</span>)</div><div class="line">      .payment-modal-footer(@click=<span class="string">'handPayment'</span>) 确认支付</div><div class="line">  transition(name=<span class="string">'fade'</span>)</div><div class="line">    span.modal(v-<span class="keyword">if</span>=<span class="string">'modal.visible'</span>) &#123;&#123; modal.content&#125;&#125;</div></pre></td></tr></table></figure>
<h2 id="添加控制数据"><a href="#添加控制数据" class="headerlink" title="添加控制数据"></a>添加控制数据</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">data () &#123;</div><div class="line">  <span class="keyword">return</span> &#123;</div><div class="line">    <span class="comment">// 是否弹出信息框</span></div><div class="line">    showInfo: <span class="literal">false</span>,</div><div class="line">    <span class="attr">info</span>: &#123;</div><div class="line">      <span class="attr">name</span>: <span class="string">''</span>,</div><div class="line">      <span class="attr">phoneNumber</span>: <span class="string">''</span>,</div><div class="line">      <span class="attr">address</span>: <span class="string">''</span></div><div class="line">    &#125;,</div><div class="line">    <span class="attr">modal</span>: &#123;</div><div class="line">      <span class="attr">visible</span>: <span class="literal">false</span>,</div><div class="line">      <span class="attr">content</span>: <span class="string">'成功'</span>,</div><div class="line">      <span class="attr">timer</span>: <span class="literal">null</span></div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="添加控制modal方法"><a href="#添加控制modal方法" class="headerlink" title="添加控制modal方法"></a>添加控制modal方法</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">toggleModal</span>(<span class="params">obj, content</span>) </span>&#123;</div><div class="line">    clearTimeout(obj.timer)</div><div class="line">    obj.visible = <span class="literal">true</span></div><div class="line">    obj.content = content</div><div class="line">    obj.timer = setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">      obj.visible = fade</div><div class="line">    &#125;, <span class="number">1500</span>)</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<h2 id="唤起支付方法"><a href="#唤起支付方法" class="headerlink" title="唤起支付方法"></a>唤起支付方法</h2><p>拿到用户信息，判断字段是否填写正确，接着创建订单，处理数据成功后的处理，调用微信支付方法</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">methods: &#123;</div><div class="line">  <span class="keyword">async</span> handPayment(item) &#123;</div><div class="line">        <span class="keyword">const</span> that = <span class="keyword">this</span></div><div class="line">        <span class="keyword">const</span> &#123; name, address, phoneNumber &#125; = <span class="keyword">this</span>.info</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (!name || !address || !phoneNumber) &#123;</div><div class="line">          toggleModal(<span class="keyword">this</span>.modal, <span class="string">'收获信息忘填了哦~'</span>)</div><div class="line">          <span class="keyword">return</span></div><div class="line">        &#125;</div><div class="line">        <span class="comment">// 创建订单</span></div><div class="line">        <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="keyword">this</span>.$store.dispatch(<span class="string">'createOrder'</span>, &#123;</div><div class="line">          <span class="attr">productId</span>: <span class="keyword">this</span>.product.id</div><div class="line">          name: name,</div><div class="line">          <span class="attr">address</span>: address,</div><div class="line">          <span class="attr">phoneNumber</span>: phoneNumber</div><div class="line">        &#125;)</div><div class="line">        <span class="keyword">const</span> data = res.data</div><div class="line">        <span class="keyword">if</span> (!data || !data.success) &#123;</div><div class="line">          toggleModal(<span class="keyword">this</span>.modal, <span class="string">'服务器异常，请等待后重新尝试'</span>)</div><div class="line">          <span class="keyword">return</span></div><div class="line">        &#125;</div><div class="line">        <span class="comment">// 调用微信支付</span></div><div class="line">        <span class="built_in">window</span>.wx.chooseWXPay(&#123;</div><div class="line">         </div><div class="line">        &#125;)</div><div class="line">      &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="支付接口调用"><a href="#支付接口调用" class="headerlink" title="支付接口调用"></a>支付接口调用</h2><p>简要的说明下微信支付业务流程：</p>
<ol>
<li>从客户端拿到预付订单</li>
<li>用户通过js-sdk发起微信支付的请求</li>
<li>对支付成功或失败的信息做处理</li>
</ol>
<h3 id="添加中间件"><a href="#添加中间件" class="headerlink" title="添加中间件"></a>添加中间件</h3><p>在页面初始化时，跟服务器端做加密的动作，让我们在微信网页的环境下把当前的域名包括页面注册到微信环境里，允许我们调用接口。</p>
<p> wechatInit中要做的工作其实是让微信知道在当前url能调用某些微信api接口的能力，发送getWechatSignature事件，在服务器端针对url进行加密，把签名值返回给前端。拿到全局微信sdk对象，通过config接口注入权限验证配置，通过ready接口处理成功验证，初始化微信按钮</p>
<p><strong>static/mixins/wechat.js</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</div><div class="line">  <span class="attr">methods</span>: &#123;</div><div class="line">    <span class="keyword">async</span> wechatInit(url) &#123;</div><div class="line">      <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="keyword">this</span>.$store.dispatch(<span class="string">'getWechatSignature'</span>, url)</div><div class="line">      <span class="keyword">const</span> &#123; data, success &#125; = res.data</div><div class="line">      <span class="keyword">if</span> (!success) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'不能成功获取服务器签名！'</span>)</div><div class="line">      <span class="keyword">const</span> wx = <span class="built_in">window</span>.wx</div><div class="line">      wx.config(&#123;</div><div class="line">        <span class="comment">// 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。</span></div><div class="line">        debug: <span class="literal">true</span>,</div><div class="line">        <span class="attr">appId</span>: data.appId, <span class="comment">// 必填，公众号的唯一标识</span></div><div class="line">        timestamp: data.timestamp, <span class="comment">// 必填，生成签名的时间戳</span></div><div class="line">        nonceStr: data.noncestr, <span class="comment">// 必填，生成签名的随机串</span></div><div class="line">        signature: data.signature,<span class="comment">// 必填，签名，见附录1</span></div><div class="line">        jsApiList: [</div><div class="line">          <span class="string">'previewImage'</span>,</div><div class="line">          <span class="string">'hideAllNonBaseMenuItem'</span>,</div><div class="line">          <span class="string">'showMenuItems'</span>,</div><div class="line">          <span class="string">'onMenuShareTimeline'</span>,</div><div class="line">          <span class="string">'onMenuShareAppMessage'</span>,</div><div class="line">          <span class="string">'chooseWXPay'</span></div><div class="line">        ] <span class="comment">// 必填，需要使用的 JS 接口列表，所有JS接口列表见附录2</span></div><div class="line">      &#125;)</div><div class="line"></div><div class="line">      wx.ready(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">       <span class="comment">// this.wechatSetMenu()</span></div><div class="line">      &#125;)</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="添加实际支付行为"><a href="#添加实际支付行为" class="headerlink" title="添加实际支付行为"></a>添加实际支付行为</h3><p>在deal页面中获取到当前商品后初始化网页端的微信支付行为，引入wechat中间件</p>
<p><strong>pages/deal/index.vue</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"> <span class="keyword">import</span> wechat <span class="keyword">from</span> <span class="string">'../static/mixins/wechat.js'</span></div><div class="line"> </div><div class="line">mixins: [wechat],</div></pre></td></tr></table></figure>
<p>发起支付请求</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">window</span>.wx.chooseWXPay(&#123;</div><div class="line">  <span class="attr">timestamp</span>: data.timestamp,</div><div class="line">  <span class="attr">nonceStr</span>: data.nonceStr,</div><div class="line">  <span class="attr">package</span>: data.package,</div><div class="line">  <span class="attr">signType</span>: data.signType,</div><div class="line">  <span class="attr">paySign</span>: data.paySign,</div><div class="line">  <span class="attr">success</span>: <span class="function">(<span class="params">response</span>) =&gt;</span> &#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      <span class="built_in">window</span>.WeixinJSBridge.log(response.err_msg)</div><div class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</div><div class="line">      <span class="built_in">console</span>.error(e)</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 支付成功</span></div><div class="line">    <span class="keyword">if</span> (response.err_msg === <span class="string">'get_brand_wcpay_request:ok'</span>) &#123;</div><div class="line">      toggleModal(that.modal, <span class="string">'支付成功'</span>)</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<h2 id="注意："><a href="#注意：" class="headerlink" title="注意："></a>注意：</h2><p>到这里可能要止步了，没有支付权限，原因是没有认证过的服务号才可以申请微信支付功能，如果是订阅号，认证和不认证都不能用！</p>
<h2 id="微信支付流程"><a href="#微信支付流程" class="headerlink" title="微信支付流程"></a>微信支付流程</h2><p>微信支付分为下面几个步骤：<br>1、申请一个微信公众服务号<br>2、认证微信公众服务号<br>3、认证之后才可以做微信支付模块下在公众平台下微信支付功能权限的申请，申请后才有权限<br>4、在微信商户里设置网页授权的域名、js安全接口域名、业务域名等等，并且这个域名需要是备案过的，否则不能使用微信的支付功能<br>5、到商户平台-&gt;产品中心-&gt;开发配置，添加公众号支付授权目录<br>6、下载官方的示例代码，基于这个代码选择你要用的语言代码拷贝到你的项目目录<br>7、到商户平台下载API证书，设置API密钥（需要在服务器端基于证书和密钥在服务器上生成预支付订单，这两个没有设置也是不能使用微信的支付功能）</p>
<h1 id="订单"><a href="#订单" class="headerlink" title="订单"></a>订单</h1><h2 id="订单数据"><a href="#订单数据" class="headerlink" title="订单数据"></a>订单数据</h2><p>定义订单数据字段，需要关联两个对象user和product，payType表示支付方式（比如：支付宝、网银）</p>
<p><strong>server/database/schema/payment.js</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>)</div><div class="line"><span class="keyword">const</span> &#123; Schema &#125; = mongoose</div><div class="line"><span class="keyword">const</span> Mixed = Schema.Types.Mixed</div><div class="line"><span class="keyword">const</span> ObjectId = Schema.Types.ObjectId</div><div class="line"></div><div class="line"><span class="keyword">const</span> PaymentSchema = <span class="keyword">new</span> Schema(&#123;</div><div class="line">  <span class="attr">user</span>: &#123;</div><div class="line">    <span class="attr">type</span>: ObjectId,</div><div class="line">    <span class="attr">ref</span>: <span class="string">'User'</span></div><div class="line">  &#125;,</div><div class="line">  <span class="attr">product</span>: &#123;</div><div class="line">    <span class="attr">type</span>: ObjectId,</div><div class="line">    <span class="attr">ref</span>: <span class="string">'Product'</span></div><div class="line">  &#125;,</div><div class="line">  <span class="attr">payType</span>: <span class="built_in">String</span>,</div><div class="line">  <span class="attr">totalFee</span>: <span class="built_in">Number</span>,</div><div class="line">  <span class="attr">name</span>: <span class="built_in">String</span>,</div><div class="line">  <span class="attr">phoneNumber</span>: [<span class="built_in">String</span>],</div><div class="line">  <span class="attr">address</span>: <span class="built_in">String</span>,</div><div class="line">  <span class="attr">description</span>: <span class="built_in">String</span>,</div><div class="line">  <span class="attr">order</span>: Mixed,</div><div class="line">  <span class="attr">success</span>: &#123;</div><div class="line">    <span class="attr">type</span>: <span class="built_in">Number</span>,</div><div class="line">    <span class="attr">default</span>: <span class="number">0</span></div><div class="line">  &#125;,</div><div class="line">  <span class="attr">meta</span>: &#123;</div><div class="line">    <span class="attr">createdAt</span>: &#123;</div><div class="line">      <span class="attr">type</span>: <span class="built_in">Date</span>,</div><div class="line">      <span class="attr">default</span>: <span class="built_in">Date</span>.now()</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">updatedAt</span>: &#123;</div><div class="line">      <span class="attr">type</span>: <span class="built_in">Date</span>,</div><div class="line">      <span class="attr">default</span>: <span class="built_in">Date</span>.now()</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;)</div><div class="line"></div><div class="line">PaymentSchema.pre(<span class="string">'save'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">next</span>) </span>&#123;</div><div class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.isNew) &#123;</div><div class="line">    <span class="keyword">this</span>.meta.createdAt = <span class="keyword">this</span>.meta.updatedAt = <span class="built_in">Date</span>.now()</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    <span class="keyword">this</span>.meta.updatedAt = <span class="built_in">Date</span>.now()</div><div class="line">  &#125;</div><div class="line">  next()</div><div class="line">&#125;)</div><div class="line"></div><div class="line">mongoose.model(<span class="string">'Payment'</span>, PaymentSchema)</div></pre></td></tr></table></figure>
<p>在存储数据之前判断，如果是新建数据的话同步更新时间。</p>
<h2 id="创建订单"><a href="#创建订单" class="headerlink" title="创建订单"></a>创建订单</h2><p><strong>server/routes/wechat.js</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">@post(<span class="string">'/wx-pay'</span>)</div><div class="line">@required(&#123; <span class="attr">body</span>: [<span class="string">'productId'</span>, <span class="string">'name'</span>, <span class="string">'phoneNumber'</span>, <span class="string">'address'</span> ]&#125;)</div><div class="line"><span class="keyword">async</span> createdOrder (ctx, next) &#123;</div><div class="line">	<span class="keyword">await</span> wechatPay(ctx, next)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="向微信支付系统发起支付请求"><a href="#向微信支付系统发起支付请求" class="headerlink" title="向微信支付系统发起支付请求"></a>向微信支付系统发起支付请求</h2><p>有时候在本地做域名代理时可能会带<code>::ffff:</code>类似于这样的标识，替换成<code>&#39;&#39;</code>即可。</p>
<p>用户初次登录公众号网页时会进行授权，授权后就持有用户的信息，就可以持久化session。通过productId获得product，判断它的状态。</p>
<p>通过session.user.unionid查找到user，判断如果不存在，创建User存入数据库。</p>
<p>定义订单参数，生成预支付订单，继而生成订单。</p>
<p><strong>server/controllers/wechat.js</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">wechatPay</span> (<span class="params">code</span>) </span>&#123;</div><div class="line">  <span class="keyword">const</span> ip = ctx.ip.replace(<span class="string">'::ffff:'</span>, <span class="string">''</span>)</div><div class="line">  <span class="keyword">const</span> session = ctx.session</div><div class="line">  <span class="keyword">const</span> &#123; productId, name, phoneNumber, address &#125; = ctx.request.body</div><div class="line"></div><div class="line">  <span class="keyword">const</span> product = <span class="keyword">await</span> api.product.findProduct(productId)</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (!product) &#123;</div><div class="line">    <span class="keyword">return</span> (ctx.body = &#123;</div><div class="line">      <span class="attr">success</span>: <span class="literal">false</span>,</div><div class="line">      <span class="attr">err</span>: <span class="string">'这个宝贝不在了'</span></div><div class="line">    &#125;)</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">try</span> &#123;</div><div class="line">    <span class="keyword">let</span> user = <span class="keyword">await</span> api.user.findUserByUnionId(session.user.unionid).exec()</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!user) &#123;</div><div class="line">      user = <span class="keyword">await</span> api.user.saveFromSession(session)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">const</span> orderParams = &#123;</div><div class="line">      <span class="attr">body</span>: product.title,</div><div class="line">      <span class="attr">attach</span>: <span class="string">'公众号周边手办支付'</span>,</div><div class="line">      <span class="attr">out_trade_no</span>: <span class="string">'Product'</span> + (+<span class="keyword">new</span> <span class="built_in">Date</span>),</div><div class="line">      <span class="attr">spbill_create_ip</span>: ip,</div><div class="line">      <span class="comment">// total_fee: product.price * 100,</span></div><div class="line">      total_fee: <span class="number">0.01</span> * <span class="number">100</span>,</div><div class="line">      <span class="attr">openid</span>: session.user.unionid,</div><div class="line">      <span class="attr">trade_type</span>: <span class="string">'JSAPI'</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 生成预支付订单</span></div><div class="line">    <span class="keyword">const</span> order = <span class="keyword">await</span> getParamsAsync(orderParams)</div><div class="line">    <span class="comment">// 生成订单</span></div><div class="line">    <span class="keyword">const</span> payment = <span class="keyword">await</span> api.payment.create(user, product, order, <span class="string">'公众号'</span>, &#123;</div><div class="line">      name,</div><div class="line">      address,</div><div class="line">      phoneNumber</div><div class="line">    &#125;)</div><div class="line"></div><div class="line">    ctx.body = &#123;</div><div class="line">      <span class="attr">success</span>: <span class="literal">true</span>,</div><div class="line">      <span class="attr">data</span>: payment.order</div><div class="line">    &#125;</div><div class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</div><div class="line">    ctx.body = &#123;</div><div class="line">      <span class="attr">success</span>: <span class="literal">false</span>,</div><div class="line">      <span class="attr">err</span>: e</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="支付方法"><a href="#支付方法" class="headerlink" title="支付方法"></a>支付方法</h2><p>引入第三方库<a href="https://www.npmjs.com/package/wechat-pay" target="_blank" rel="external">wechat-pay</a>支付方法</p>
<p><strong>server/wechat-lib/pay.js</strong></p>
<h3 id="获取预支付订单"><a href="#获取预支付订单" class="headerlink" title="获取预支付订单"></a>获取预支付订单</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> fs <span class="keyword">from</span> <span class="string">'fs'</span></div><div class="line"><span class="keyword">import</span> config <span class="keyword">from</span> <span class="string">'../config'</span></div><div class="line"><span class="keyword">import</span> wechatPay <span class="keyword">from</span> <span class="string">'wechat-pay'</span></div><div class="line"><span class="keyword">import</span> path <span class="keyword">from</span> <span class="string">'path'</span></div><div class="line"></div><div class="line"><span class="keyword">const</span> cert = path.resolve(__dirname, <span class="string">'../'</span>, <span class="string">'config/cert/apiclient_cert.p12'</span>)</div><div class="line"></div><div class="line"><span class="keyword">const</span> paymentConfig = &#123;</div><div class="line">  <span class="attr">appId</span>: config.shop.appId,</div><div class="line">  <span class="attr">partnerKey</span>: config.shop.partnerKey,</div><div class="line">  <span class="attr">mchId</span>: config.shop.mchId,</div><div class="line">  <span class="attr">notifyUrl</span>: config.shop.notifyUrl,</div><div class="line">  <span class="attr">ptx</span>: fs.readFileSync(cert)</div><div class="line">&#125;</div><div class="line"><span class="keyword">const</span> Payment = wechatPay.Payment</div><div class="line"><span class="keyword">const</span> payment = <span class="keyword">new</span> Payment(paymentConfig || &#123;&#125;)</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="keyword">const</span> getParamsAsync  = <span class="function">(<span class="params">order</span>) =&gt;</span> &#123;</div><div class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</div><div class="line">    payment.getBrandWCPayRequestParams(order, (err, payargs) =&gt; &#123;</div><div class="line">      <span class="keyword">if</span> (err) reject(err)</div><div class="line">      <span class="keyword">else</span> resolve(payargs)</div><div class="line">    &#125;)</div><div class="line">  &#125;)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="获取订单数据"><a href="#获取订单数据" class="headerlink" title="获取订单数据"></a>获取订单数据</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">export</span> <span class="keyword">const</span> getPayDataAsync = <span class="function">(<span class="params">req</span>) =&gt;</span> &#123;</div><div class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</div><div class="line">    <span class="keyword">let</span> data = <span class="string">''</span></div><div class="line"></div><div class="line">    req.setEncoding(<span class="string">'utf8'</span>)</div><div class="line">    req.on(<span class="string">'data'</span>, chunk =&gt; &#123;</div><div class="line">      data += chunk</div><div class="line">    &#125;)</div><div class="line">    req.on(<span class="string">'end'</span>, () =&gt; &#123;</div><div class="line">      req.rawBody = data</div><div class="line"></div><div class="line">      resolve(data)</div><div class="line">    &#125;)</div><div class="line">  &#125;)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="订单微信推送通知"><a href="#订单微信推送通知" class="headerlink" title="订单微信推送通知"></a>订单微信推送通知</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">export</span> <span class="keyword">const</span> getNoticeAsync = <span class="function">(<span class="params">rawBody</span>) =&gt;</span> &#123;</div><div class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</div><div class="line">    payment.validate(rawBody, (err, message) =&gt; &#123;</div><div class="line">      <span class="keyword">if</span> (err) reject(err)</div><div class="line">      <span class="keyword">else</span> resolve(message)</div><div class="line">    &#125;)</div><div class="line">  &#125;)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="获取所有订单列表"><a href="#获取所有订单列表" class="headerlink" title="获取所有订单列表"></a>获取所有订单列表</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">export</span> <span class="keyword">const</span> getBillAsync = <span class="function">(<span class="params">date</span>) =&gt;</span> &#123;</div><div class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</div><div class="line">    payment.downloadBill(&#123;</div><div class="line">      <span class="attr">bill_date</span>: date,</div><div class="line">      <span class="attr">bill_type</span>: <span class="string">'ALL'</span></div><div class="line">    &#125;, (err, data) =&gt; &#123;</div><div class="line">      <span class="keyword">if</span> (err) reject(err)</div><div class="line">      <span class="keyword">else</span> resolve(data)</div><div class="line">    &#125;)</div><div class="line">  &#125;)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="获取订单"><a href="#获取订单" class="headerlink" title="获取订单"></a>获取订单</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">export</span> <span class="keyword">const</span> getOrdersAsync = <span class="function">(<span class="params">params</span>) =&gt;</span> &#123;</div><div class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</div><div class="line">    payment.orderQuery(params, (err, data) =&gt; &#123;</div><div class="line">      <span class="keyword">if</span> (err) reject(err)</div><div class="line">      <span class="keyword">else</span> resolve(data)</div><div class="line">    &#125;)</div><div class="line">  &#125;)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="失败信息"><a href="#失败信息" class="headerlink" title="失败信息"></a>失败信息</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">export</span> <span class="keyword">const</span> buildFailXML = <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</div><div class="line">  <span class="keyword">return</span> payment.buildXml(&#123;</div><div class="line">    <span class="attr">return_code</span>: <span class="string">'FAIL'</span>,</div><div class="line">    <span class="attr">return_msg</span>: err.name</div><div class="line">  &#125;)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="成功信息"><a href="#成功信息" class="headerlink" title="成功信息"></a>成功信息</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">export</span> <span class="keyword">const</span> buildSuccessXML = <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</div><div class="line">  <span class="keyword">if</span> (err) <span class="keyword">return</span> buildFailXML(err)</div><div class="line"></div><div class="line">  <span class="keyword">return</span> payment.buildXml(&#123;</div><div class="line">    <span class="attr">return_code</span>: <span class="string">'SUCCESS'</span></div><div class="line">  &#125;)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="订单管理页面"><a href="#订单管理页面" class="headerlink" title="订单管理页面"></a>订单管理页面</h2><p><strong>pages/admin/payments.vue</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">&lt;template lang=<span class="string">"pug"</span>&gt;</div><div class="line">.content</div><div class="line">  .related-products</div><div class="line">    table.table</div><div class="line">      thead</div><div class="line">        tr</div><div class="line">          th 图片</div><div class="line">          th 标题</div><div class="line">          th 价格</div><div class="line">          th 支付价格</div><div class="line">          th 姓名</div><div class="line">          th 电话</div><div class="line">          th 地址</div><div class="line">          th 支付方式</div><div class="line">      tbody</div><div class="line">        tr(v-<span class="keyword">for</span>=<span class="string">'item in payments'</span>)</div><div class="line">          td</div><div class="line">            .img(v-<span class="keyword">for</span>=<span class="string">'image in item.images'</span>)</div><div class="line">              img(:src=<span class="string">'imageCDN2 + image'</span>)</div><div class="line">          td &#123;&#123;item.product.title&#125;&#125;</div><div class="line">          td &#123;&#123;item.product.price&#125;&#125;</div><div class="line">          td &#123;&#123;item.product.totalFee&#125;&#125;</div><div class="line">          td &#123;&#123;item.name&#125;&#125;</div><div class="line">          td &#123;&#123;item.phoneNumber&#125;&#125;</div><div class="line">          td &#123;&#123;item.address&#125;&#125;</div><div class="line">          td &#123;&#123;item.payType&#125;&#125;</div><div class="line">&lt;<span class="regexp">/template&gt;</span></div></pre></td></tr></table></figure>
<h3 id="增加中间件"><a href="#增加中间件" class="headerlink" title="增加中间件"></a>增加中间件</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">middleware: <span class="string">'auth'</span>,</div></pre></td></tr></table></figure>
<h3 id="获取支付数据"><a href="#获取支付数据" class="headerlink" title="获取支付数据"></a>获取支付数据</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">async created() &#123;</div><div class="line">    this.$store.dispatch(&apos;fetchPayments&apos;)</div><div class="line">  &#125;,</div></pre></td></tr></table></figure>
<h3 id="路由"><a href="#路由" class="headerlink" title="路由"></a>路由</h3><p><strong>server/routers/admin.js</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">@get(<span class="string">'payments'</span>)</div><div class="line"><span class="keyword">async</span> getPayments (ctx, next) &#123;</div><div class="line">  <span class="keyword">const</span> data = <span class="keyword">await</span> api.payment.fetchPayments()</div><div class="line">  ctx.body = &#123;</div><div class="line">    <span class="attr">success</span>: <span class="literal">true</span>,</div><div class="line">    <span class="attr">data</span>: data</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>store/actions.js</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">async</span> fetchPayments (&#123; state &#125;) &#123;</div><div class="line">    <span class="keyword">let</span> &#123; data &#125; = <span class="keyword">await</span> Services.getPayments()</div><div class="line">    state.payments = data.data</div><div class="line"></div><div class="line">    <span class="keyword">return</span> data</div><div class="line">  &#125;,</div></pre></td></tr></table></figure>
<h3 id="请求路径"><a href="#请求路径" class="headerlink" title="请求路径"></a>请求路径</h3><p><strong>store/services.js</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">getPayments() &#123;</div><div class="line">    <span class="keyword">return</span> axios.get(<span class="string">`<span class="subst">$&#123;baseUrl&#125;</span>/admin/payments`</span>)</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="启动服务和代理"><a href="#启动服务和代理" class="headerlink" title="启动服务和代理"></a>启动服务和代理</h1><p>将sunny二进制文件复制到项目，另外再创建一个shell文件写入配置，配置就是启动sunny的shell命令</p>
<p><strong>server/bin/ngrok</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line"></div><div class="line">./server/bin/sunny clientid 你的隧道id</div></pre></td></tr></table></figure>
<p>添加服务启动配置，修改<strong>package.json</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="string">"ngrok"</span>: <span class="string">"./server/bin/ngrok"</span>,</div></pre></td></tr></table></figure>
<p>给ngrok文件添加权限</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">chmod u+x ngrok</div></pre></td></tr></table></figure>
<p>这样就可以在在同一个目录下通过npm run dev启动本地开发编译环境，同时也可以通过npm run ngrok启动代理端口的工具环境。</p>
<h1 id="编译压缩"><a href="#编译压缩" class="headerlink" title="编译压缩"></a>编译压缩</h1><p>修改<strong>package.json</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="string">"build"</span>: <span class="string">"nuxt build"</span>,</div></pre></td></tr></table></figure>
<p>执行编译命令：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm run build</div></pre></td></tr></table></figure>
<p>编译后启动命令：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">NODE_ENV=production node start</div></pre></td></tr></table></figure>
<h1 id="分离本地与线上环境"><a href="#分离本地与线上环境" class="headerlink" title="分离本地与线上环境"></a>分离本地与线上环境</h1><p>区分本地环境与线上环境，通过NODE_ENV进行文件切换。</p>
<p>新建本地开发环境文件development.json</p>
<p><strong>server/config/development.json</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"db"</span>: <span class="string">"mongodb://localhost/nuxtka"</span>,</div><div class="line">  <span class="attr">"SITE_ROOT_URL"</span>: <span class="string">"http://nuxtssr.ngrok.xiaomiqiu.cn"</span>,</div><div class="line">  <span class="attr">"wechat"</span>: &#123;</div><div class="line">    <span class="attr">"appID"</span>: <span class="string">"你的appID"</span>,</div><div class="line">    <span class="attr">"appSecret"</span>: <span class="string">"你的appSecret"</span>,</div><div class="line">    <span class="attr">"token"</span>: <span class="string">"你的token"</span></div><div class="line">  &#125;,</div><div class="line">  <span class="attr">"qiniu"</span>: &#123;</div><div class="line">    <span class="attr">"AK"</span>: <span class="string">"你的七牛云AK"</span>,</div><div class="line">    <span class="attr">"SK"</span>: <span class="string">"你的七牛云SK"</span></div><div class="line">  &#125;,</div><div class="line">  <span class="attr">"mina"</span>: &#123;</div><div class="line">    <span class="attr">"appid"</span>: <span class="string">"你的公众平台的appid"</span>,</div><div class="line">    <span class="attr">"secret"</span>: <span class="string">"你的公众平台的secret"</span></div><div class="line">  &#125;,</div><div class="line">  <span class="attr">"shop"</span>: &#123;</div><div class="line">    <span class="attr">"appID"</span>: <span class="string">"你的 shop ID"</span>,</div><div class="line">    <span class="attr">"mchId"</span>: <span class="string">"你的 shop mchId"</span>,</div><div class="line">    <span class="attr">"notifyUrl"</span>: <span class="string">"接收通知的 URL"</span>,</div><div class="line">    <span class="attr">"key"</span>: <span class="string">""</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>线上文件production.json</p>
<p><strong>server/config/production.json</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"db"</span>: <span class="string">"mongodb://localhost/nuxtka"</span>,</div><div class="line">  <span class="attr">"SITE_ROOT_URL"</span>: <span class="string">"http://nuxtssr.ngrok.xiaomiqiu.cn"</span>,</div><div class="line">  <span class="attr">"wechat"</span>: &#123;</div><div class="line">    <span class="attr">"appID"</span>: <span class="string">"你的appID"</span>,</div><div class="line">    <span class="attr">"appSecret"</span>: <span class="string">"你的appSecret"</span>,</div><div class="line">    <span class="attr">"token"</span>: <span class="string">"你的token"</span></div><div class="line">  &#125;,</div><div class="line">  <span class="attr">"qiniu"</span>: &#123;</div><div class="line">    <span class="attr">"AK"</span>: <span class="string">"你的七牛云AK"</span>,</div><div class="line">    <span class="attr">"SK"</span>: <span class="string">"你的七牛云SK"</span></div><div class="line">  &#125;,</div><div class="line">  <span class="attr">"mina"</span>: &#123;</div><div class="line">    <span class="attr">"appid"</span>: <span class="string">"你的公众平台的appid"</span>,</div><div class="line">    <span class="attr">"secret"</span>: <span class="string">"你的公众平台的secret"</span></div><div class="line">  &#125;,</div><div class="line">  <span class="attr">"shop"</span>: &#123;</div><div class="line">    <span class="attr">"appID"</span>: <span class="string">"你的 shop ID"</span>,</div><div class="line">    <span class="attr">"mchId"</span>: <span class="string">"你的 shop mchId"</span>,</div><div class="line">    <span class="attr">"notifyUrl"</span>: <span class="string">"接收通知的 URL"</span>,</div><div class="line">    <span class="attr">"key"</span>: <span class="string">""</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>根据当前nodejs运行时NODE_ENV是开发环境还是线上环境进行切换，修改文件：</p>
<p><strong>server/config/index.js</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> _ <span class="keyword">from</span> <span class="string">'lodash'</span></div><div class="line"><span class="keyword">import</span> &#123; resolve &#125; <span class="keyword">from</span> <span class="string">'path'</span></div><div class="line"></div><div class="line"><span class="keyword">const</span> host = process.env.HOST || <span class="string">'localhost'</span></div><div class="line"><span class="keyword">const</span> env = process.env.NODE_ENV || <span class="string">'development'</span></div><div class="line"><span class="keyword">const</span> conf = <span class="built_in">require</span>(reslove(__dirname, <span class="string">`./<span class="subst">$&#123;env&#125;</span>.json`</span>))</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> _.assign(&#123;</div><div class="line">  env,</div><div class="line">  host</div><div class="line">&#125;, conf)</div></pre></td></tr></table></figure>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>


    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/前端/" rel="tag"><i class="fa fa-tag"></i> 前端</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/09/15/微信公众号开发(九)：用户登录/" rel="next" title="微信公众号开发(九)：用户登录">
                <i class="fa fa-chevron-left"></i> 微信公众号开发(九)：用户登录
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
        <!-- JiaThis Button BEGIN -->
<div class="jiathis_style">
  <a class="jiathis_button_tsina"></a>
  <a class="jiathis_button_tqq"></a>
  <a class="jiathis_button_weixin"></a>
  <a class="jiathis_button_cqq"></a>
  <a class="jiathis_button_douban"></a>
  <a class="jiathis_button_renren"></a>
  <a class="jiathis_button_qzone"></a>
  <a class="jiathis_button_kaixin001"></a>
  <a class="jiathis_button_copy"></a>
  <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank"></a>
  <a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript" >
  var jiathis_config={
    hideMore:false
  }
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js" charset="utf-8"></script>
<!-- JiaThis Button END -->

      
    </div>
  </div>

          
          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="余鸢" />
          <p class="site-author-name" itemprop="name">余鸢</p>
          <p class="site-description motion-element" itemprop="description">整理学习文档</p>
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">69</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">15</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">19</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#小程序"><span class="nav-number">1.</span> <span class="nav-text">小程序</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#登录"><span class="nav-number">1.1.</span> <span class="nav-text">登录</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用code获取-session-key-和-openid"><span class="nav-number">1.2.</span> <span class="nav-text">使用code获取 session_key 和 openid</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#获取sessionKey"><span class="nav-number">1.3.</span> <span class="nav-text">获取sessionKey</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#获取用户资料"><span class="nav-number">1.4.</span> <span class="nav-text">获取用户资料</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#解密算法"><span class="nav-number">1.5.</span> <span class="nav-text">解密算法</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#公众号商城支付"><span class="nav-number">2.</span> <span class="nav-text">公众号商城支付</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#增加中间件控制"><span class="nav-number">2.1.</span> <span class="nav-text">增加中间件控制</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#添加购买-取消动画框"><span class="nav-number">2.2.</span> <span class="nav-text">添加购买/取消动画框</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#添加控制数据"><span class="nav-number">2.3.</span> <span class="nav-text">添加控制数据</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#添加控制modal方法"><span class="nav-number">2.4.</span> <span class="nav-text">添加控制modal方法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#唤起支付方法"><span class="nav-number">2.5.</span> <span class="nav-text">唤起支付方法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#支付接口调用"><span class="nav-number">2.6.</span> <span class="nav-text">支付接口调用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#添加中间件"><span class="nav-number">2.6.1.</span> <span class="nav-text">添加中间件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#添加实际支付行为"><span class="nav-number">2.6.2.</span> <span class="nav-text">添加实际支付行为</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#注意："><span class="nav-number">2.7.</span> <span class="nav-text">注意：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#微信支付流程"><span class="nav-number">2.8.</span> <span class="nav-text">微信支付流程</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#订单"><span class="nav-number">3.</span> <span class="nav-text">订单</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#订单数据"><span class="nav-number">3.1.</span> <span class="nav-text">订单数据</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#创建订单"><span class="nav-number">3.2.</span> <span class="nav-text">创建订单</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#向微信支付系统发起支付请求"><span class="nav-number">3.3.</span> <span class="nav-text">向微信支付系统发起支付请求</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#支付方法"><span class="nav-number">3.4.</span> <span class="nav-text">支付方法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#获取预支付订单"><span class="nav-number">3.4.1.</span> <span class="nav-text">获取预支付订单</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#获取订单数据"><span class="nav-number">3.4.2.</span> <span class="nav-text">获取订单数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#订单微信推送通知"><span class="nav-number">3.4.3.</span> <span class="nav-text">订单微信推送通知</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#获取所有订单列表"><span class="nav-number">3.4.4.</span> <span class="nav-text">获取所有订单列表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#获取订单"><span class="nav-number">3.4.5.</span> <span class="nav-text">获取订单</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#失败信息"><span class="nav-number">3.4.6.</span> <span class="nav-text">失败信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#成功信息"><span class="nav-number">3.4.7.</span> <span class="nav-text">成功信息</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#订单管理页面"><span class="nav-number">3.5.</span> <span class="nav-text">订单管理页面</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#增加中间件"><span class="nav-number">3.5.1.</span> <span class="nav-text">增加中间件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#获取支付数据"><span class="nav-number">3.5.2.</span> <span class="nav-text">获取支付数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#路由"><span class="nav-number">3.5.3.</span> <span class="nav-text">路由</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#请求路径"><span class="nav-number">3.5.4.</span> <span class="nav-text">请求路径</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#启动服务和代理"><span class="nav-number">4.</span> <span class="nav-text">启动服务和代理</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#编译压缩"><span class="nav-number">5.</span> <span class="nav-text">编译压缩</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#分离本地与线上环境"><span class="nav-number">6.</span> <span class="nav-text">分离本地与线上环境</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">余鸢</span>
</div>



<div class="powered-by">
<i class="fa fa-user-md"></i><span id="busuanzi_container_site_uv">
  本站访客数:<span id="busuanzi_value_site_uv"></span>
</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  




	





  





  

  
      <!-- UY BEGIN -->
      <script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid="></script>
      <!-- UY END -->
  




  
  

  

  

  

  


</body>
</html>
